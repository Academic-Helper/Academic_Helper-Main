name: Manual Deploy QA to Netlify (SSR)

on:
  workflow_dispatch:

jobs:
  build:
    name: Build (QA) - Netlify Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Install Netlify CLI
        run: npm i -g netlify-cli

      # Inject QA env at build time (Netlify/Next needs these during build)
      - name: Create QA env (.env.local)
        run: |
          cat > .env.local << 'EOF'
          NEXT_PUBLIC_ENV=qa
          NEXT_PUBLIC_FIREBASE_API_KEY=${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY_QA }}
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN_QA }}
          NEXT_PUBLIC_FIREBASE_PROJECT_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID_QA }}
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET_QA }}
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID_QA }}
          NEXT_PUBLIC_FIREBASE_APP_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID_QA }}
          EOF

      # Netlify build creates:
      # - publish dir (site output)
      # - functions output for Next SSR adapter
      - name: Netlify build (QA)
        run: |
          netlify build \
            --site "${{ secrets.NETLIFY_SITE_ID_QA }}" \
            --auth "${{ secrets.NETLIFY_AUTH_TOKEN }}"

      # Upload Netlify build output for the deploy job
      - name: Upload Netlify build artifact
        uses: actions/upload-artifact@v4
        with:
          name: netlify-build
          path: |
            .netlify
            netlify.toml
          if-no-files-found: error

  deploy:
    name: Deploy to Netlify (QA) - Manual
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout (for repo metadata)
        uses: actions/checkout@v4

      - name: Download Netlify build artifact
        uses: actions/download-artifact@v4
        with:
          name: netlify-build
          path: .

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Netlify CLI
        run: npm i -g netlify-cli

      # Deploy the exact build produced in job 1 (includes SSR functions)
      - name: Deploy to Netlify QA (production deploy)
        run: |
          netlify deploy \
            --site "${{ secrets.NETLIFY_SITE_ID_QA }}" \
            --auth "${{ secrets.NETLIFY_AUTH_TOKEN }}" \
            --prod \
            --dir "$(cat .netlify/state.json | node -e "let d=''; process.stdin.on('data',c=>d+=c).on('end',()=>{const j=JSON.parse(d); console.log(j.publish || j.build?.publish || '');})")"
