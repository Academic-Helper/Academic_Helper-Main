name: Manual Deploy QA to Netlify (SSR)

on:
  workflow_dispatch:

jobs:
  build:
    name: Build (QA)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Install Netlify CLI
        run: npm i -g netlify-cli

      - name: Create QA env (.env.local)
        run: |
          cat > .env.local << 'EOF'
          NEXT_PUBLIC_ENV=qa
          NEXT_PUBLIC_FIREBASE_API_KEY=${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY_QA }}
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN_QA }}
          NEXT_PUBLIC_FIREBASE_PROJECT_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID_QA }}
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET_QA }}
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID_QA }}
          NEXT_PUBLIC_FIREBASE_APP_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID_QA }}
          EOF

      - name: Install Netlify CLI
        run: npm i -g netlify-cli

      - name: Link Netlify site (QA)
        run: |
          mkdir -p .netlify
          cat > .netlify/state.json << EOF
          {
            "siteId": "${{ secrets.NETLIFY_SITE_ID_QA }}"
          }
          EOF

      - name: Netlify build (QA)
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        run: netlify build

      - name: Upload Netlify build artifact
        uses: actions/upload-artifact@v4
        with:
          name: netlify-build
          path: |
            .netlify
            netlify.toml
          if-no-files-found: error

  deploy:
    name: Deploy to Netlify (QA)
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Netlify build artifact
        uses: actions/download-artifact@v4
        with:
          name: netlify-build
          path: .

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Netlify CLI
        run: npm i -g netlify-cli

      - name: Deploy to Netlify QA (prod)
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        run: |
          netlify deploy \
            --site "${{ secrets.NETLIFY_SITE_ID_QA }}" \
            --prod \
            --dir ".netlify/dist"
